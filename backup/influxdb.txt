mkdir -p /etc/systemd/system/docker.service.d
cat >> /etc/systemd/system/docker.service.d/http-proxy.conf  << EOF
[Service]
Environment="HTTP_PROXY=http://thenorth.f.ftq.me:52579"
Environment="HTTPS_PROXY=http://thenorth.f.ftq.me:52579"
Environment="NO_PROXY=localhost,127.0.0.1,docker.io"
EOF

systemctl daemon-reload
systemctl show --property=Environment docker

systemctl restart docker
systemctl enable docker


cat <<EOF | sudo tee /etc/yum.repos.d/influxdb.repo
[influxdb]
name = InfluxDB Repository - RHEL \$releasever
baseurl = https://repos.influxdata.com/rhel/\$releasever/\$basearch/stable
enabled = 1
gpgcheck = 1
gpgkey = https://repos.influxdata.com/influxdb.key
EOF

systemctl enable influxdb
systemctl start influxdb
systemctl status influxdb


yum install https://grafanarel.s3.amazonaws.com/builds/grafana-4.0.2-1481203731.x86_64.rpm
#curl -s https://packagecloud.io/install/repositories/grafana/stable/script.rpm.sh | sudo bash
#sudo yum install grafana-4.0.2-1481203731.x86_64

systemctl enable grafana-server
systemctl start grafana-server
systemctl status grafana-server

docker run \
  --volume=/:/rootfs:ro \
  --volume=/var/run:/var/run:rw \
  --volume=/sys:/sys:ro \
  --volume=/var/lib/docker/:/var/lib/docker:ro \
  --publish=8080:8080 \
  --detach=true \
  --name=cadvisor \
  google/cadvisor:latest \
  -storage_driver=influxdb \
  -storage_driver_db=testdb \
  -storage_driver_host=172.28.3.96:8086

docker run \
  --volume=/:/rootfs:ro \
  --volume=/var/run:/var/run:rw \
  --volume=/sys:/sys:ro \
  --volume=/var/lib/docker/:/var/lib/docker:ro \
  -p 8080:8080 \
  --detach=true \
  --name=cadvisor \
  google/cadvisor:latest \
  -storage_driver=influxdb \
  -storage_driver_db=cadvisor \
  -storage_driver_host=172.28.3.96:8086


docker run -d \
  -p 3000:3000 \
  -e INFLUXDB_HOST=localhost \
  -e INFLUXDB_PORT=8086 \
  -e INFLUXDB_NAME=cadvisor \
  -e INFLUXDB_USER=root \
  -e INFLUXDB_PASS=root \
  --name grafana \
  grafana/grafana



  # 创建数据库
create database "cadvisor"; 

# 创建用户
CREATE USER "cadvisor" WITH PASSWORD "cadvisor"

# 用户授权
grant all privileges on "cadvisor" to "cadvisor"

# 授予读写权限
grant WRITE on "cadvisor" to "cadvisor"
grant READ on "cadvisor" to "cadvisor"
