---
title: Docker学习总结
date: 2017-01-03 11:28:07
categories: ["docker"]
tags: ["docker"]
---
docker是个好东西，虽然年轻，但很有前途。一些大的公司(包括谷歌、IBM、惠普、微软等)都有在使用。有些人不太愿意使用新的技术，怕不稳定，但我个人认为好的东西主要勇于使用，大公司都在使用，怕什么呢，新技术不敢于使用，怎么能进步呢^_^
docker相关的概念请大家自行谷歌。新的技术用百度是搜索不到的，还是谷歌好...
如果是没有docker基础的话，建议买一本<<第一本docker书 修订版>>，写得不错，入门不错。
docker正式环境只能在linux中使用，所以本文以vagrant+centos7为例介绍。具体环境请参考[Vagrant环境搭建](Vagrant环境搭建.html)

## 操作系统要求
Docker只能运行在64位Linux中，并且内核需要3.8以上，建议使用centos 7版本。以下是我本机的环境，请参考：
```bash
[root@www ~] cat /etc/redhat-release 
CentOS Linux release 7.2.1511 (Core) 
[root@www ~] uname -a
Linux www.mymydocker.com 3.10.0-327.4.5.el7.x86_64 #1 SMP Mon Jan 25 22:07:14 UTC 2016 x86_64 x86_64 x86_64 GNU/Linux
[root@www ~] ll /sys/class/misc/device-mapper
lrwxrwxrwx 1 root root 0 Dec 13 08:19 /sys/class/misc/device-mapper -> ../../devices/virtual/misc/device-mapper
[root@www ~] grep device-mapper /proc/devices 
253 device-mapper
```

## 安装docker

### 卸载旧的docker版本
当前docker最新版本为1.12，请先卸载旧的docker版本：
```bash
rpm -e docker-1.10.3-59.el7.centos.x86_64 \
 docker-common-1.10.3-59.el7.centos.x86_64 \
 container-selinux-1.10.3-59.el7.centos.x86_64
```

## 关闭防火墙
```bash
systemctl disable iptables firewalld
systemctl stop iptables firewalld
```

### 添加docker用户组
注意：rpm安装已经自动创建了该组，无需再创建。
```bash
groupadd -g 2016 docker
#useradd docker -u 2016 -g 2016
```
当发现有docker组时，会自动以docker组启动。

### 添加yum源：
```bash
tee /etc/yum.repos.d/docker.repo <<-'EOF'
[docker]
name=Docker Repository
baseurl=http://mirrors.aliyun.com/docker-engine/yum/repo/main/centos/7/
enabled=1
gpgcheck=1
gpgkey=http://mirrors.aliyun.com/docker-engine/yum/gpg
EOF
```

### 安装
```bash
yum install docker-engine
```

### docker加速
官网的速度太慢了，可以使用daocloud加速。请参考[what-is-daocloud-accelerator](http://docs.daocloud.io/faq/what-is-daocloud-accelerator)
具体操作如下：
> 注册https://www.daocloud.io/账户
> 点击加速器，获取地址
> 修改/usr/lib/systemd/system/docker.service文件：
```bash
#ExecStart=/usr/bin/dockerd --bip=10.1.10.1/24 --insecure-registry=172.28.3.96:5000 --registry-mirror=http://3fecfd09.m.daocloud.io
sed -i "s;^ExecStart=/usr/bin/dockerd$;ExecStart=/usr/bin/dockerd \
--registry-mirror=http://3fecfd09.m.daocloud.io;" \
 /usr/lib/systemd/system/docker.service
```

### 添加代理
国内网站无法访问google的一些资源，可以通过docker代理方式访问：
```bash
mkdir -p /etc/systemd/system/docker.service.d
cat >> /etc/systemd/system/docker.service.d/http-proxy.conf  << EOF
[Service]
Environment="HTTP_PROXY=http://xxxx:xxxx"
Environment="HTTPS_PROXY=http://xxxx:xxxx"
Environment="NO_PROXY=localhost,127.0.0.1,docker.io"
EOF

systemctl daemon-reload
systemctl show --property=Environment docker

systemctl restart docker
systemctl enable docker
```
然后 ps aux | grep docker 然后你就会发现带有镜像的启动参数了。

由于我这边的HTTP_PROXY与HTTPS_PROXY是付费购买的，同时只能几个client访问，需要的话请自行搜索或者购买。

## docker私服搭建
参考
> http://www.cnblogs.com/lienhua34/p/4922130.html
> https://docs.docker.com/registry/deploying/

### 安装registry:2

#### 普通安装方式
安装：
```bash
docker create -p 5000:5000 --restart=always --name registry \
 -v /docker/registry:/var/lib/registry registry:2
```
映射主机的/docker/registry目录到容器的/var/lib/registry

异常解决：
当出现Get https://192.168.10.6:5000/v1/_ping: Connection failed错误时，由于改为http方式，需要修改以下配置：
```bash
vim /usr/lib/systemd/system/docker.service
#添加--insecure-registry参数
ExecStart=/usr/bin/dockerd --insecure-registry=192.168.10.6:5000
#重启
systemctl daemon-reload
systemctl restart docker
```

#### 证书安装方式
> 参考: https://www.tianmaying.com/tutorial/docker-registry
先/etc/pki/tls/openssl.cnf配置，在该文件中找到[ v3_ca ]，在它下面添加如下内容：
```bash
[ v3_ca ]
# Extensions for a typical CA
subjectAltName = IP:172.28.3.96
```

安装：
```bash
openssl req \
  -subj "/C=CN/ST=GuangDong/L=GuangZhou/CN=172.28.3.96:5000" \
  -newkey rsa:4096 -nodes -sha256 -keyout domain.key \
  -x509 -days 365 -out domain.crt 

mkdir -p /etc/docker/certs.d/172.28.3.96:5000
cp domain.crt /etc/docker/certs.d/172.28.3.96:5000/ca.crt
mkdir -p /root/certs/
cp domain.crt domain.key /root/certs/

docker run \
    -d \
    --name private_registry  --restart=always \
    -e SETTINGS_FLAVOUR=dev \
    -e STORAGE_PATH=/registry-storage \
    -v /docker/registry:/var/lib/registry \
    -u root \
    -p 5000:5000 \
    -v /root/certs:/certs \
    -e REGISTRY_HTTP_TLS_CERTIFICATE=/certs/domain.crt \
    -e REGISTRY_HTTP_TLS_KEY=/certs/domain.key \
    registry:2
```
注意：如果采用证书方式，需要去掉/usr/lib/systemd/system/docker.service中的--insecure-registry参数，然后再重启：
```bash
systemctl daemon-reload
systemctl restart docker
```

如果要用docker pull或者docker push的客户端，都需要执行以下命令：
```bash
mkdir -p /etc/docker/certs.d/172.28.3.96:5000
cp domain.crt /etc/docker/certs.d/172.28.3.96:5000/ca.crt
```
否则，会报以下错误：
```bash
Error response from daemon: Get https://172.28.3.96:5000/v1/_ping: x509: certificate signed by unknown authority
```

### 启动
```bash
docker start registry
```

### 查看ip
```bash
docker exec registry ip addr
```

## 导入本地的images到私服中
push.sh:
```bash
#!/bin/sh
imgs=$(docker images|awk '{print $1":"$2}')
for img in $imgs
do
  docker tag $img 172.28.3.96:5000/$img
  docker push 172.28.3.96:5000/$img
  docker rmi 172.28.3.96:5000/$img
done
```

pull.sh:
```bash
#!/bin/sh
imgs=$(docker images|awk '{print $1":"$2}')
for img in $imgs
do
  docker pull 172.28.3.96:5000/$img
  docker tag 172.28.3.96:5000/$img $img
  docker rmi 172.28.3.96:5000/$img
done
```

## 安装registry ui
可以使用docker-registry-frontend，具体操作如下：

### 普通安装方式
```bash
#docker run -d -p 8080:8080 atcol/docker-registry-ui(不支持V2，不能使用)
sudo docker run \
  -d \
  -e ENV_DOCKER_REGISTRY_HOST=172.28.3.96 \
  -e ENV_DOCKER_REGISTRY_PORT=5000 \
  -p 9002:80 \
  konradkleine/docker-registry-frontend:v2
#重启：
docker stop $(docker ps -a |grep docker-registry-frontend|awk '{print $1}')
docker start $(docker ps -a |grep docker-registry-frontend|awk '{print $1}')
```
访问：
http://172.28.3.96:9002

### 证书安装方式
```bash
sudo docker run \
  -d \
  -e ENV_DOCKER_REGISTRY_HOST=172.28.3.96 \
  -e ENV_DOCKER_REGISTRY_PORT=5000 \
  -e ENV_DOCKER_REGISTRY_USE_SSL=1 \
  -e ENV_USE_SSL=yes \
  -v /root/certs/domain.crt:/etc/apache2/server.crt:ro \
  -v /root/certs/domain.key:/etc/apache2/server.key:ro \
  -p 9002:443 \
  konradkleine/docker-registry-frontend:v2
```

异常解决：
如果出现The proxy server could not handle the request GET /v2/_catalog的错误，需要添加：
```bash
-e ENV_DOCKER_REGISTRY_USE_SSL=1
```

访问：
https://172.28.3.96:9002


