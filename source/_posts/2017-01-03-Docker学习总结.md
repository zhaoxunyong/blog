---
title: Docker学习总结
date: 2017-01-03 11:28:07
categories: ["docker"]
tags: ["docker"]
---
docker是个好东西，虽然年轻，但很有前途。一些大的公司(包括谷歌、IBM、惠普、微软等)都有在使用。有些人不太愿意使用新的技术，怕不稳定，但我个人认为好的东西主要勇于使用，大公司都在使用，怕什么呢，新技术不敢于使用，怎么能进步呢^_^
docker相关的概念请大家自行谷歌。新的技术用百度是搜索不到的，还是谷歌好...
如果是没有docker基础的话，建议买一本<<第一本docker书 修订版>>，写得不错，入门不错。
docker正式环境只能在linux中使用，所以本文以vagrant+centos7为例介绍。具体环境请参考[Vagrant环境搭建](Vagrant环境搭建.html)

## 操作系统要求
Docker只能运行在64位Linux中，并且内核需要3.8以上，建议使用centos 7版本。以下是我本机的环境，请参考：
```bash
[root@www ~] cat /etc/redhat-release 
CentOS Linux release 7.2.1511 (Core) 
[root@www ~] uname -a
Linux www.mymydocker.com 3.10.0-327.4.5.el7.x86_64 #1 SMP Mon Jan 25 22:07:14 UTC 2016 x86_64 x86_64 x86_64 GNU/Linux
[root@www ~] ll /sys/class/misc/device-mapper
lrwxrwxrwx 1 root root 0 Dec 13 08:19 /sys/class/misc/device-mapper -> ../../devices/virtual/misc/device-mapper
[root@www ~] grep device-mapper /proc/devices 
253 device-mapper
```

## 安装docker

### 卸载旧的docker版本
当前docker最新版本为1.12，请先卸载旧的docker版本：
```bash
rpm -e docker-1.10.3-59.el7.centos.x86_64 \
 docker-common-1.10.3-59.el7.centos.x86_64 \
 container-selinux-1.10.3-59.el7.centos.x86_64
```

### 添加docker用户组
```bash
groupadd -g 2016 docker
#useradd docker -u 2016 -g 2016
```
当发现有docker组时，会自动以docker组启动。

### 添加yum源：
```bash
tee /etc/yum.repos.d/docker.repo <<-'EOF'
[docker]
name=Docker Repository
baseurl=http://mirrors.aliyun.com/docker-engine/yum/repo/main/centos/7/
enabled=1
gpgcheck=1
gpgkey=http://mirrors.aliyun.com/docker-engine/yum/gpg
EOF
```

### 安装
```bash
yum install docker-engine
```

### docker加速
官网的速度太慢了，可以使用daocloud加速。请参考[what-is-daocloud-accelerator](http://docs.daocloud.io/faq/what-is-daocloud-accelerator)
具体操作如下：
> 注册https://www.daocloud.io/账户
> 点击加速器，获取地址
> 修改/usr/lib/systemd/system/docker.service文件：
```bash
sed -i "s;^ExecStart=/usr/bin/dockerd$;ExecStart=/usr/bin/dockerd \
--registry-mirror=http://3fecfd09.m.daocloud.io;" \
 /usr/lib/systemd/system/docker.service
```

### 添加代理
国内网站无法访问google的一些资源，可以通过docker代理方式访问：
```bash
mkdir -p /etc/systemd/system/docker.service.d
cat >> /etc/systemd/system/docker.service.d/http-proxy.conf  << EOF
[Service]
Environment="HTTP_PROXY=http://xxxx:xxxx"
Environment="HTTPS_PROXY=http://xxxx:xxxx"
Environment="NO_PROXY=localhost,127.0.0.1,docker.io"
EOF

systemctl daemon-reload
systemctl show --property=Environment docker

systemctl restart docker
systemctl enable docker
```
然后 ps aux | grep docker 然后你就会发现带有镜像的启动参数了。

由于我这边的HTTP_PROXY与HTTPS_PROXY是付费购买的，同时只能几个client访问，需要的话请自行搜索或者购买。

## docker私服搭建
参考
> http://www.cnblogs.com/lienhua34/p/4922130.html
> https://docs.docker.com/registry/deploying/

### 安装registry:2
```bash
docker create -p 5000:5000 --restart=always --name registry \
 -v /docker/registry:/var/lib/registry registry:2
```
映射主机的/docker/registry目录到容器的/var/lib/registry

### 启动
```bash
docker start registry
```

### 查看ip
```bash
docker exec registry ip addr
```

### 异常解决
当出现Get https://192.168.10.6:5000/v1/_ping: Connection failed错误时，由于改为http方式，需要修改以下配置：
```bash
vim /usr/lib/systemd/system/docker.service
#添加--insecure-registry参数
ExecStart=/usr/bin/dockerd --bip=10.1.10.1/24 --insecure-registry=192.168.10.6:5000 --registry-mirror=http://3fecfd09.m.daocloud.io
#重启
systemctl daemon-reload
systemctl restart docker
```

