---
title: ssl证书制作
date: 2017-01-19 12:46:33
categories: ["SSL"]
tags: ["SSL"]
---
之前公司网站转为使用https方式访问，在此记录一下过程。

<!-- more -->

## 生成https/ssl的证书
假设生成根域名证书，域名为：*.abc.com。

### 颁发证书
如果是对外的服务，需要公共CA机构签署，不需要这步。
内网环境CA要给别人颁发证书，首先自己得有一个作为根证书：
```bash
#初始化
cd /etc/pki/CA/
touch index.txt serial
echo '01' > serial

#生成根密钥
#为了安全起见，修改cakey.pem私钥文件权限为600或400
umask 077; openssl genrsa -out private/cakey.pem 2048

#生成根证书
openssl req -new -x509 -key private/cakey.pem -out cacert.pem
```

根据提示输入相关信息：
![openssl](/images/openssl.png)

### 为web服务器生成ssl密钥
创建签名请求，然后通过私有CA签署：
```bash
#openssl req -newkey rsa:4096 -nodes -sha256 -keyout abc.com.key -out abc.com.csr
openssl req -newkey rsa:2048 -keyout abc.com.key -out abc.com.csr
#或者
#openssl genrsa -out abc.com.key 2048
#openssl req -new -key abc.com.key -out abc.com.csr

# 自己签署
#一般内网环境采用自己签署(如果是对外的服务，需要公共CA机构签署)：
openssl ca -in abc.com.csr -out abc.com.crt -cert /etc/pki/CA/cacert.pem -keyfile /etc/pki/CA/private/cakey.pem -outdir ./
```

创建签名请求，创建一个加密的私钥，然后通过私钥签署：
```bash
# 生成私钥：
openssl genrsa -des3 -out /csr/abc.key.pem.encrypted 2048
# 生成解密后的private key：
openssl rsa -in /csr/abc.key.pem.encrypted -out /csr/abc.com.key

# 创建签名请求：
openssl req -utf8 -config /etc/pki/tls/openssl.cnf \
  -subj "/C=CN/ST=guangdong/L=shenzhen/CN=*.abc.com" \
  -new -key /csr/abc.key.pem.encrypted \
  -out /csr/abc.req.csr -days 365

# 自己签署
#一般内网环境采用自己签署(如果是对外的服务，需要公共CA机构签署)：
openssl x509 -req -days 365 -signkey /csr/abc.key.pem.encrypted -in /csr/abc.req.csr -out /csr/abc.cert.crt
```

### 公共CA机构签署

可以购买geotrust服务或者申请startssl免费一年的服务，具体请参考[免费申请-StartSSL-证书](https://mritd.me/2016/06/22/%E5%85%8D%E8%B4%B9%E7%94%B3%E8%AF%B7-StartSSL-%E8%AF%81%E4%B9%A6/)


```bash
# 将csr内容上传geotrust后，会生成IntermediateCA.crt、ssl_certificate.crt两个文件
cat ssl_certificate.crt IntermediateCA.crt >> abc.com.crt

### 添加
#将abc.com.crt与abc.key.pem加入到nginx中即可，比如：
server {
  listen 80;
  server_name abc.com;
  rewrite ^(.*) https://$server_name$1 permanent;
}

server {
  listen 443;
  server_name abc.com;
  access_log /var/log/nginx/your-domain.log main;

  ssl on;
  ssl_certificate      /etc/nginx/ssl/abc.com.crt;
  ssl_certificate_key  /etc/nginx/ssl/abc.com.key;

  location / {

    log_not_found on;

    proxy_pass http://127.0.0.1:8080;
    proxy_read_timeout 300;
    proxy_connect_timeout 300;
    proxy_redirect off;

    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header Host              $http_host;
    proxy_set_header X-Real-IP         $remote_addr;
  }
}
```

### 私有CA签署时，浏览器不信任证书的解决方案
以macos为例：
```bash
#下载ca文件
sz /etc/pki/CA/cacert.pem
```
然后再导入系统，具体请参考：[解决Mac Chrome打开HTTPS证书错误问题](http://www.cnblogs.com/snandy/p/3262661.html)


## jks证书
```bash
#生成jks：
keytool -genkey -alias abc.com -keyalg RSA -keystore /csr/abc.jks -keysize 2048 -dname "CN=*.abc.com,OU=,O=xxxx有限公司,L=深圳市,ST=广东省,C=CN" -storepass "Aa123456" -keypass "Aa123456"
#注意：CN表示颁发给哪个url，可以用*.abc.com表示所有
```

转换jks为OpenSSL的PEM格式文件(.key + .crt)
```bash
#生成csr文件：
keytool -certreq -keyalg RSA -alias abc.com -file /csr/abc.req.csr -keystore /csr/abc.jks -storepass "Aa123456" -keypass "Aa123456"
```
生成私钥:
windows下运行[kestore-export](/files/kestore-export.zip)中的工具：
```bash
JKS2PFX.bat abc.jks "Aa123456" "abc.com" "key/abc" "D:\Developer\java\jdk1.7.0_51\jre\bin"

#上传key/abc.com.key到linux下并执行：
openssl rsa -in abc.com.key -des3 -out abc.key.encrypted

#自己签署csr文件：
#openssl x509 -req -days 365 -in /csr/abc.req.csr -signkey /csr/abc.key.encrypted -out /csr/abc.cert.crt
```

```bash
#将csr内容上传geotrust后，会生成IntermediateCA.crt、ssl_certificate.crt两个文件
cat ssl_certificate.crt IntermediateCA.crt >> abc.com.crt
```

## 参考
> https://mritd.me/2016/07/03/Harbor-%E4%BC%81%E4%B8%9A%E7%BA%A7-Docker-Registry-HTTPS%E9%85%8D%E7%BD%AE/
> https://mritd.me/2016/07/02/%E4%BA%92%E8%81%94%E7%BD%91%E5%8A%A0%E5%AF%86%E5%8F%8AOpenSSL%E4%BB%8B%E7%BB%8D%E5%92%8C%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8/
> https://mritd.me/2016/06/22/%E5%85%8D%E8%B4%B9%E7%94%B3%E8%AF%B7-StartSSL-%E8%AF%81%E4%B9%A6/
> http://seanlook.com/2015/01/18/openssl-self-sign-ca/
> http://seanlook.com/2015/01/15/openssl-certificate-encryption/
> http://seanlook.com/2015/01/07/tls-ssl/#comments
> http://netsecurity.51cto.com/art/200602/21066.htm
> http://cnzhx.net/blog/self-signed-certificate-as-trusted-root-ca-in-windows/
> http://www.cnblogs.com/snandy/p/3262661.html



