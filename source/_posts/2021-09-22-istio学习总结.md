---
title: istio学习总结
date: 2021-09-22 15:41:46
categories: ["kubernetes"]
tags: ["kubernetes"]
toc: true
---

istio学习总结

<!-- more -->

## 安装

不使用micro.k8s中的istio插件。

- https://istio.io/latest/docs/setup/getting-started/

```bash
#https://istio.io/latest/zh/docs/setup/install/istioctl/
curl -L https://istio.io/downloadIstio | sh -
cd istio-1.11.4
#https://istio.io/latest/zh/docs/setup/getting-started/
vim /etc/profile.d/istio.sh
export PATH="$PATH:/works/istio/istio-1.11.4/bin"

. /etc/profile

istioctl install --set profile=demo -y
kubectl label namespace default istio-injection=enabled

#Example
#https://blog.frognew.com/2021/07/learning-istio-1.10-01.html
kubectl apply -f samples/bookinfo/platform/kube/bookinfo.yaml
kubectl get pods -w

kubectl apply -f samples/bookinfo/networking/bookinfo-gateway.yaml

istioctl analyze
✔ No validation issues found when analyzing namespace: default.

kubectl exec "$(kubectl get pod -l app=ratings -o jsonpath='{.items[0].metadata.name}')" -c ratings -- curl -s productpage:9080/productpage | grep -o "<title>.*</title>"

kubectl get svc istio-ingressgateway -n istio-system

export INGRESS_HOST=$(kubectl get po -l istio=ingressgateway -n istio-system -o jsonpath='{.items[0].status.hostIP}')
export INGRESS_PORT=$(kubectl -n istio-system get service istio-ingressgateway -o jsonpath='{.spec.ports[?(@.name=="http2")].port}')

export GATEWAY_URL=$INGRESS_HOST:$INGRESS_PORT
echo "$GATEWAY_URL"
echo "http://$GATEWAY_URL/productpage"

#查看仪表板
kubectl apply -f samples/addons
kubectl rollout status deployment/kiali -n istio-system

istioctl dashboard --address 0.0.0.0 kiali

#istioctl dashboard kiali
由于是localhost地址，需要通过nginx转发一下：
cat /etc/nginx/conf.d/nginx.conf 
server {
  listen 8888;
  server_name  www.a.com;
  server_tokens off;
  client_max_body_size 0;
  charset utf-8;

  ssl off;

  # Individual nginx logs for this GitLab vhost
  access_log  /var/log/nginx/www_access.log main;
  error_log   /var/log/nginx/www_error.log;

   location / {
     #deny all;
     proxy_pass http://127.0.0.1:20001;
   }

}
http://localhost:20001/kiali
http://192.168.95.234:8888/kiali

#Mocking some traffic data:
for i in $(seq 1 100); do curl -s -o /dev/null "http://$GATEWAY_URL/productpage"; done

#卸载
kubectl delete -f samples/addons
istioctl manifest generate --set profile=demo | kubectl delete --ignore-not-found=true -f -
kubectl delete namespace istio-system
kubectl label namespace default istio-injection-
#or https://istio.io/latest/zh/docs/examples/bookinfo/#cleanup
samples/bookinfo/platform/kube/cleanup.sh

kubectl get virtualservices   #-- there should be no virtual services
kubectl get destinationrules  #-- there should be no destination rules
kubectl get gateway           #-- there should be no gateway
kubectl get pods              #-- the Bookinfo pods should be deleted
```

## 卸载

```bash
#https://istio.io/latest/zh/docs/setup/install/istioctl/#uninstall
#可选的 --purge 参数将删除所有 Istio 资源，包括可能被其他 Istio 控制平面共享的、集群范围的资源。
istioctl x uninstall --purge
```

## 使用

- https://blog.frognew.com/2021/07/learning-istio-1.10-01.html
- http://jartto.wang/2020/07/29/istio-1/
- https://developer.51cto.com/art/202101/641511.htm

