---
title: WSL
date: 2020-12-01 11:00:22
tags: ["Linux"]
toc: true
---

Windows Subsystem for Linux（简称WSL）是一个在Windows 10上能够运行原生Linux二进制可执行文件（ELF格式）的兼容层。它是由微软与Canonical公司合作开发，其目标是使纯正的Ubuntu 14.04 "Trusty Tahr"映像能下载和解压到用户的本地计算机，并且映像内的工具和实用工具能在此子系统上原生运行。

<!-- more -->

## 安装WSL

安装最新的Win10：cn_windows_10_business_editions_version_20h2_x64_dvd_f978664f.iso

安装参考：https://docs.microsoft.com/zh-cn/windows/wsl/install-win10

```bash
#步骤 1 - 启用适用于 Linux 的 Windows 子系统
#以管理员身份打开 PowerShell 并运行：
dism.exe /online /enable-feature /featurename:Microsoft-Windows-Subsystem-Linux /all /norestart
#步骤 2 - 启用虚拟机功能
#以管理员身份打开 PowerShell 并运行：
dism.exe /online /enable-feature /featurename:VirtualMachinePlatform /all /norestart
#步骤 3 - 下载 Linux 内核更新包
wget http://aka.ms/wsl2kernelmsix64
#步骤 4 - 将 WSL 2 设置为默认版本
wsl --set-default-version 2
#步骤 5 - 安装所选的 Linux 分发
直接在Microsoft Store中搜索并安装
```

如果已经安装了最新的Win10与docker desktop后，可以直接跳到[步骤4](https://docs.microsoft.com/zh-cn/windows/wsl/install-win10#step-4---download-the-linux-kernel-update-package)，下载以下文件进行安装：

https://wslstorestorage.blob.core.windows.net/wslblob/wsl_update_x64.msi

安装docker时也会提示更新这个。另外注意：不需要开启Hyper-V。安装完后设置一下默认为v2:

```bash
wsl --set-default-version 2

```

## 安装ubuntu

参考：https://docs.microsoft.com/zh-cn/windows/wsl/install-win10#step-6---install-your-linux-distribution-of-choice

## 终端

Windows终端(建议)：

参考：

- https://docs.microsoft.com/zh-cn/windows/terminal/get-started
- https://blog.walterlv.com/post/add-a-new-profile-for-windows-terminal.html

添加git-bash支持：

```bash
{
    "closeOnExit" : true,
    "commandline" : "D:\\Developer\\Git\\bin\\bash.exe --login -i",
    "guid" : "{1d4e097e-fe87-4164-97d7-3ca794c316fd}",
    "icon" : "D:\\Developer\\Git\\git-bash.png",
    "name" : "Bash",
    "startingDirectory" : "%USERPROFILE%"
}
```

wsl-terminal：

参考：https://link.jianshu.com/?t=https://github.com/goreliu/wsl-terminal

## 安装docker

参考：

- https://docs.docker.com/docker-for-windows/wsl/
- https://kubernetes.io/blog/2020/05/21/wsl-docker-kubernetes-on-the-windows-desktop/

在windows中安装Docker Desktop，在docker的Settings/Resources/WSL Integration选择ubuntu。

查看已经安装的系统：

```bash
wsl.exe -l -v
#wsl.exe --set-version Ubuntu-20.04 2
#wsl.exe --set-default-version 2
```

## 启动kubernetes

直接在docker-desktop的settings中开启即可。不过要先设置proxy，否则无法下载。

```
http://192.168.101.175:1082
127.0.0.1,localhost,10.0.0.0/8,172.0.0.0/8,192.168.0.0/16,*.zerofinance.net,*.aliyun.com,*.163.com,*.docker-cn.com
```

启动ingress:

参考：https://github.com/docker/for-win/issues/7094

```bash
#https://kubernetes.github.io/ingress-nginx/deploy/#docker-for-mac
 #kubectl.exe create -f https://raw.githubusercontent.com/kubernetes/ingress-nginx/controller-0.32.0/deploy/static/provider/cloud/deploy.yaml
 #Resolved: Unable to connect to the server
 proxy_on
wget https://raw.githubusercontent.com/kubernetes/ingress-nginx/controller-v0.41.2/deploy/static/provider/cloud/deploy.yaml
proxy_off
 kubectl apply -f deploy.yaml
```

demo.yaml

```bash
kind: Service
apiVersion: v1
metadata:
  name: hello
  labels:
    app: hello
spec:
  type: NodePort
  ports:
  - protocol: TCP
    name: http
    port: 8080
    targetPort: 8080
  selector:
    app: hello

---

kind: Deployment
apiVersion: apps/v1
metadata:
  name: hello
  labels:
    app: hello
spec:
  replicas: 1
  selector:
    matchLabels:
      app: hello
  template:
    metadata:
      labels:
        app: hello
    spec:
      containers:
      - name: hello
        # image: paulbouwer/hello-kubernetes:1.8
        image: gcr.io/google-samples/hello-app:1.0
        ports:
        - containerPort: 8080

---

apiVersion: networking.k8s.io/v1beta1 # for versions before 1.14 use extensions/v1beta1
kind: Ingress
metadata:
  name: hello
  # annotations:
  #   nginx.ingress.kubernetes.io/rewrite-target: /$1
    # nginx.ingress.kubernetes.io/whitelist-source-range: 192.168.147.174/32
spec:
  rules:
  - host: hello.info
    http:
      paths:
      - path: /
        backend:
          serviceName: hello
          servicePort: 8080
```

## 设置默认Linux发行版

参考：http://www.xitongzhijia.net/xtjc/20180316/122477.html

```bash
wslconfig /l
wslconfig /setdefault Ubuntu-20.04
```

## 备注与还原

```bash
#https://www.howtogeek.com/426562/how-to-export-and-import-your-linux-systems-on-windows-10/
#Backup
wsl --list
wsl --export Ubuntu-20.04 D:\Developer\WSL\Bak\Ubuntu-20.04.tar
wsl --import Ubuntu D:\Developer\WSL D:\Developer\WSL\Bak\Ubuntu-20.04.tar
```

## Local development with Java

参考：

- https://www.telepresence.io/discussion/overview
- https://github.com/cesartl/telepresence-k8s
- https://kubernetes.io/zh/docs/tasks/debug-application-cluster/local-debugging/
- https://cloud.google.com/community/tutorials/developing-services-with-k8s

### Install

https://www.telepresence.io/reference/windows


```bash
#For Windows:
1. Install Windows Subsystem for Linux.
2. Start the BASH.exe program.
3. Install Telepresence by following the Ubuntu instructions above.
>wsl
curl -s https://packagecloud.io/install/repositories/datawireio/telepresence/script.deb.sh | sudo bash
sudo apt install --no-install-recommends telepresence

#For ubuntu:
curl -s https://packagecloud.io/install/repositories/datawireio/telepresence/script.deb.sh | sudo bash
sudo apt install --no-install-recommends telepresence
```

### Usage

- https://anjia0532.github.io/2019/01/21/debug-cloud-native/
- https://www.telepresence.io/tutorials/docker
- https://www.telepresence.io/tutorials/kubernetes
- https://github.com/telepresenceio/telepresence/tree/master/examples/guestbook
- https://github.com/cesartl/telepresence-k8s

```bash
#https://www.telepresence.io/tutorials/java
#kubectl apply -f https://raw.githubusercontent.com/telepresenceio/telepresence/master/docs/tutorials/hello-world.yaml
#kubectl create deployment hello-world --image=datawire/hello-world
#kubectl expose deployment hello-world --type=LoadBalancer --port=8000
#$ curl 127.0.0.1:8000
#Hello, world!
git clone https://github.com/cesartl/telepresence-k8s
cd telepresence-k8s
#Setting up Quote Of the Moment Service
kubectl run qotm --image=datawire/qotm:1.3 --port=5000 --expose
#Basic profile
#Using the basic profile, service disovery using K8S API is disable; The Ribbon client use the service #host name directly:
qotm:
    ribbon:
        listOfServers: qotm:5000

#telepresence --docker-run --rm -it pstauffer/curl -- curl http://hello-world:8000/
#telepresence --new-deployment telepresence-k8s --expose 8080:8080 --run-shell
#telepresence --new-deployment telepresence-k8s --expose 8080 --expose 8081 --run-shell
#telepresence --swap-deployment telepresence-k8s --docker-run --rm -it --name mynginx -p 8080:80 nginx
#telepresence --new-deployment telepresence-k8s --docker-run --rm -it --name mynginx -p 8081:80 nginx
#telepresence --swap-deployment hello-world --expose 8000 --run python3 -m http.server 8000 &
telepresence --new-deployment telepresence-k8s --run-shell

#spring-boot部分版本（2.0.0.RELEASE可以，其他版本不明）通过mvnDebug或者MAVEN_DEBUG_OPTS参数启动时，不支持remote debug:
#cat /Developer/apache-maven-3.3.9/bin/mvnDebug
#MAVEN_DEBUG_OPTS="-Xdebug -Xrunjdwp:transport=dt_socket,server=y,suspend=y,address=8000"
>cd /mnt/d/Developer/workspace/telepresence-k8s/
>export PROFILES=basic
>mvn spring-boot:run -Dspring-boot.run.jvmArguments="-Xdebug -Xrunjdwp:transport=dt_socket,server=y,suspend=n,address=8000"
#Preparing to Execute Maven in Debug Mode
#此处会暂停，只到有remote debug过来才会继续往下, 如不希望，可修改以上MAVEN_DEBUG_OPTS中的suspend=n
#Listening for transport dt_socket at address: 8000
#通过eclipse远程debug即可，注意：pom.xml不要开启以下，否则不能远程debug:
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-devtools</artifactId>
    <optional>true</optional>
</dependency>
#以上当代码修改时会自动重启，没必要。
#Testing:
curl localhost:8080/rest/quote/cesar
```

### JRebel

```bash
#https://www.jrebel.com/success/products/jrebel/free-trial
#https://www.jrebel.com/products/jrebel/quickstart/eclipse/
#https://www.jrebel.com/products/jrebel/download/prev-releases
#https://manuals.jrebel.com/jrebel/standalone/activate.html
#Plugin for eclipse:
#update site: 
http://update.zeroturnaround.com/update-site
#Download ZIP
http://update.zeroturnaround.com/update-site/update-site.zip

#Crack
#https://www.cnblogs.com/flyrock/archive/2019/09/23/11574617.html
#Generating GUID  from: 
https://www.guidgen.com/
#服务器地址： Pasting the following url on the "Licensing service"
https://jrebel.qekang.com/{GUID}
https://jrebel.qekang.com/d1b8919f-e1e9-4a8d-84da-0c43d75aa970
aaa@bbb.com
#Activation for standalone:
wget https://www.jrebel.com/download/jrebel/496
cd /Developer/jrebel/bin
./activate.sh https://jrebel.qekang.com/d1b8919f-e1e9-4a8d-84da-0c43d75aa970 aaa@bbb.com

#https://manuals.jrebel.com/jrebel/standalone/springboot.html#spring-boot-2-x-using-maven
#https://manuals.jrebel.com/jrebel/standalone/config.html#rebel-xml
#https://www.javazhiyin.com/22460.html
mvn spring-boot:run -Dspring-boot.run.jvmArguments="-agentpath:/Developer/jrebel/lib/libjrebel64.so"
#注意：项目必须位于linux目录下才能生效，如果是/mnt下面的windows目录则不会生效。正常时会有以下提示：
2020-12-14 12:26:33 JRebel: Reloading class 'com.ctl.telepresencek8s.DummyRestController'.
2020-12-14 12:26:38 JRebel: Reconfiguring bean 'dummyRestController' [com.ctl.telepresencek8s.DummyRestController]
```

### demo

- https://github.com/zq2599/blog_demos
- https://xinchen.blog.csdn.net/article/details/92394559
- http://www.mydlq.club/article/31

```bash
#account-service
#mvn clean install fabric8:deploy -Dfabric8.generator.from=fabric8/java-jboss-openjdk8-jdk -Pkubernetes
cd /mnt/d/Developer/workspace/java-k8s/spring-cloud-k8s-account-service
mvn clean install fabric8:deploy -Pkubernetes
#cd /mnt/d/Developer/workspace/java-k8s/spring-cloud-k8s-web-service
#mvn clean install fabric8:deploy -Pkubernetes
#telepresence --swap-deployment web-service --run-shell
telepresence --new-deployment web-service --run-shell
#当为new-deployment时，调用服务时会报： Did not find any endpoints in ribbon in namespace [null] for name [account-service] and portName [null]
#https://github.com/telepresenceio/telepresence/issues/947
export KUBERNETES_NAMESPACE=default
cd /mnt/d/Developer/workspace/java-k8s/spring-cloud-k8s-web-service
#spring-boot部分版本（2.0.0.RELEASE可以，其他版本不明）通过mvnDebug或者MAVEN_DEBUG_OPTS参数启动时，不支持remote debug:
mvn spring-boot:run -Dspring-boot.run.jvmArguments="-Xdebug -Xrunjdwp:transport=dt_socket,server=y,suspend=n,address=8000"
curl 127.0.0.1:8080/account
kubectl scale --replicas=0 deployment account-service
```

注意：spring-boot部分版本通过mvnDebug启动时，不支持remote debug，具体原因不明，但可通过以下方式开启remote debug:

#https://docs.spring.io/spring-boot/docs/2.3.4.RELEASE/maven-plugin/reference/html/

```bash
<plugin>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-maven-plugin</artifactId>
    <configuration>
      <jvmArguments>
        -Xdebug -Xrunjdwp:transport=dt_socket,server=y,suspend=n,address=8000
      </jvmArguments>
    </configuration>
    <executions>
        <execution>
            <goals>
                <goal>repackage</goal>
            </goals>
        </execution>
    </executions>
</plugin>
```

或者：

```bash
mvn spring-boot:run -Dspring-boot.run.jvmArguments="-Xdebug -Xrunjdwp:transport=dt_socket,server=y,suspend=n,address=8000"
```

### fabric8-maven-plugin

```bash
#Copying remote config into "~/.kube/config" of local
#https://github.com/fabric8io/fabric8-maven-plugin/tree/master/samples
cd /mnt/d/Developer/workspace/java-k8s/spring-cloud-k8s-account-service
#export DOCKER_HOST="tcp://registry.gcalls.cn:2375"
-Ddocker.registry=
#The most mavenish way is to add a server to the Maven settings file /Developer/apache-maven-3.3.9/conf/settings.xml
<server>
    <id>registry.gcalls.cn</id>
    <username>dave.zhao</username>
    <password>Aa654321</password>
</server>

#指定外部的Dockerfile与deployment.yaml/service.yaml文件：
#https://maven.fabric8.io/#external-dockerfile
<plugin>
    <groupId>io.fabric8</groupId>
    <artifactId>fabric8-maven-plugin</artifactId>
    <version>${fabric8.maven.plugin.version}</version>
    <executions>
        <execution>
            <id>fmp</id>              
            <properties>
                <spring.profile>default</spring.profile>
            </properties>
            <goals>
                <goal>resource</goal>
                <goal>build</goal>
                <goal>push</goal>
                <goal>deploy</goal>
            </goals>
        </execution>
    </executions>
    <configuration>   
        <dockerHost>tcp://registry.gcalls.cn:2375</dockerHost>
        <images>
            <image>
            <name>registry.gcalls.cn/xwallet/${project.name}:${project.version}</name>
            <build>
                <dockerFile>${project.basedir}/src/main/docker/Dockerfile</dockerFile>
                <contextDir>${project.basedir}/</contextDir>
                <filter>@</filter>
            </build>
            </image>
        </images>
        <enricher>
            <config>
                <fmp-service>
                    <type>NodePort</type>
                </fmp-service>
            </config>
        </enricher>
    </configuration>
</plugin>
#Running:
#test ok
#export DOCKER_HOST="tcp://registry.gcalls.cn:2375"
#mvn clean install fabric8:push fabric8:deploy -Pkubernetes -Ddocker.registry=registry.gcalls.cn
.maven-dockerinclude:
target/*.jar

#Dockerfile
FROM java:8-jdk
RUN mkdir /app
WORKDIR /app
ENV APPNAME=account-service \
    VERSION=0.0.1-SNAPSHOT \
    CONFIG=/config/
RUN ln -snf /usr/share/zoneinfo/Asia/Shanghai /etc/localtime && echo Asia/Shanghai > /etc/timezone
COPY target/${APPNAME}-${VERSION}.jar /app/
ENTRYPOINT ["sh", "-c", "java -Djava.security.egd=file:/dev/./urandom -jar /app/${APPNAME}-${VERSION}.jar --spring.config.location=${CONFIG} --spring.profiles.active=@spring.profile@"]
EXPOSE 8100

#account-service-deployment.yml
kind: Deployment
apiVersion: apps/v1
metadata:
  name: account-service
  namespace: default
  labels:
    app: account-service
    group: com.xwallet
    version: 0.0.1-SNAPSHOT
    provider: fabric8
spec:
  replicas: 1
  selector:
    matchLabels:
      app: account-service
      group: com.xwallet
      version: 0.0.1-SNAPSHOT
      provider: fabric8
  template:
    metadata:
      labels:
        app: account-service
        group: com.xwallet
        version: 0.0.1-SNAPSHOT
        provider: fabric8
    spec:
      containers:
      - name: account-service
        #image: registry.gcalls.cn/xwallet/account-service:0.0.1-SNAPSHOT
        imagePullPolicy: Always
        ports:
        - containerPort: 8089

#account-service-service.yml
kind: Service
apiVersion: v1
metadata:
  name: account-service
  namespace: default
  labels:
    app: account-service
    group: com.xwallet
    version: 0.0.1-SNAPSHOT
    provider: fabric8
spec:
  type: NodePort
  ports:
  - protocol: TCP
    name: http
    port: 8080
    targetPort: 8080
  selector:
    app: account-service
    group: com.xwallet
    version: 0.0.1-SNAPSHOT
    provider: fabric8

#mvn clean install fabric8:push fabric8:deploy -Pkubernetes
mvn clean install -Pkubernetes
```

## 其他参考

> https://www.jianshu.com/p/f59f902fd885

