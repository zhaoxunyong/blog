---
title: WSL
date: 2020-12-01 11:00:22
tags: ["Linux"]
toc: true
---

Windows Subsystem for Linux（简称WSL）是一个在Windows 10上能够运行原生Linux二进制可执行文件（ELF格式）的兼容层。它是由微软与Canonical公司合作开发，其目标是使纯正的Ubuntu 14.04 "Trusty Tahr"映像能下载和解压到用户的本地计算机，并且映像内的工具和实用工具能在此子系统上原生运行。

<!-- more -->

## 安装WSL

安装最新的Win10：cn_windows_10_business_editions_version_20h2_x64_dvd_f978664f.iso

安装参考：https://docs.microsoft.com/zh-cn/windows/wsl/install-win10

```bash
#步骤 1 - 启用适用于 Linux 的 Windows 子系统
#以管理员身份打开 PowerShell 并运行：
dism.exe /online /enable-feature /featurename:Microsoft-Windows-Subsystem-Linux /all /norestart
#步骤 2 - 启用虚拟机功能
#以管理员身份打开 PowerShell 并运行：
dism.exe /online /enable-feature /featurename:VirtualMachinePlatform /all /norestart
#步骤 3 - 下载 Linux 内核更新包
wget http://aka.ms/wsl2kernelmsix64
#步骤 4 - 将 WSL 2 设置为默认版本
wsl --set-default-version 2
#步骤 5 - 安装所选的 Linux 分发
直接在Microsoft Store中搜索并安装
```

如果已经安装了最新的Win10与docker desktop后，可以直接跳到[步骤4](https://docs.microsoft.com/zh-cn/windows/wsl/install-win10#step-4---download-the-linux-kernel-update-package)，下载以下文件进行安装：

https://wslstorestorage.blob.core.windows.net/wslblob/wsl_update_x64.msi

安装docker时也会提示更新这个。另外注意：不需要开启Hyper-V。安装完后设置一下默认为v2:

```bash
wsl --set-default-version 2

```

## 安装ubuntu

参考：https://docs.microsoft.com/zh-cn/windows/wsl/install-win10#step-6---install-your-linux-distribution-of-choice

## 终端

Windows终端(建议)：

参考：

- https://docs.microsoft.com/zh-cn/windows/terminal/get-started
- https://blog.walterlv.com/post/add-a-new-profile-for-windows-terminal.html

添加git-bash支持：

```bash
{
    "closeOnExit" : true,
    "commandline" : "D:\\Developer\\Git\\bin\\bash.exe --login -i",
    "guid" : "{1d4e097e-fe87-4164-97d7-3ca794c316fd}",
    "icon" : "D:\\Developer\\Git\\git-bash.png",
    "name" : "Bash",
    "startingDirectory" : "%USERPROFILE%"
}
```

wsl-terminal：

参考：https://link.jianshu.com/?t=https://github.com/goreliu/wsl-terminal


## 设置默认Linux发行版

参考：http://www.xitongzhijia.net/xtjc/20180316/122477.html

```bash
wslconfig /l
wslconfig /setdefault Ubuntu-20.04

wsl.exe -l -v
#wsl.exe --set-version Ubuntu-20.04 2
#wsl.exe --set-default-version 2
```

## 备注与还原

```bash
#https://www.howtogeek.com/426562/how-to-export-and-import-your-linux-systems-on-windows-10/
#Backup
wsl --list
wsl --export Ubuntu-20.04 D:\Developer\WSL\Bak\Ubuntu-20.04.tar
wsl --import Ubuntu D:\Developer\WSL D:\Developer\WSL\Bak\Ubuntu-20.04.tar
```



### fabric8-maven-plugin

```bash
#Copying remote config into "~/.kube/config" of local
#https://github.com/fabric8io/fabric8-maven-plugin/tree/master/samples
cd /mnt/d/Developer/workspace/java-k8s/spring-cloud-k8s-account-service
#export DOCKER_HOST="tcp://registry.gcalls.cn:2375"
-Ddocker.registry=
#The most mavenish way is to add a server to the Maven settings file /Developer/apache-maven-3.3.9/conf/settings.xml
<server>
    <id>registry.gcalls.cn</id>
    <username>dave.zhao</username>
    <password>Aa654321</password>
</server>

#指定外部的Dockerfile与deployment.yaml/service.yaml文件：
#https://maven.fabric8.io/#external-dockerfile
<plugin>
    <groupId>io.fabric8</groupId>
    <artifactId>fabric8-maven-plugin</artifactId>
    <version>${fabric8.maven.plugin.version}</version>
    <executions>
        <execution>
            <id>fmp</id>              
            <properties>
                <spring.profile>default</spring.profile>
            </properties>
            <goals>
                <goal>resource</goal>
                <goal>build</goal>
                <goal>push</goal>
                <goal>deploy</goal>
            </goals>
        </execution>
    </executions>
    <configuration>   
        <dockerHost>tcp://registry.gcalls.cn:2375</dockerHost>
        <images>
            <image>
            <name>registry.gcalls.cn/xwallet/${project.name}:${project.version}</name>
            <build>
                <dockerFile>${project.basedir}/src/main/docker/Dockerfile</dockerFile>
                <contextDir>${project.basedir}/</contextDir>
                <filter>@</filter>
            </build>
            </image>
        </images>
        <enricher>
            <config>
                <fmp-service>
                    <type>NodePort</type>
                </fmp-service>
            </config>
        </enricher>
    </configuration>
</plugin>
#Running:
#test ok
#export DOCKER_HOST="tcp://registry.gcalls.cn:2375"
#mvn clean install fabric8:push fabric8:deploy -Pkubernetes -Ddocker.registry=registry.gcalls.cn
.maven-dockerinclude:
target/*.jar

#Dockerfile
FROM java:8-jdk
RUN mkdir /app
WORKDIR /app
ENV APPNAME=account-service \
    VERSION=0.0.1-SNAPSHOT \
    CONFIG=/config/
RUN ln -snf /usr/share/zoneinfo/Asia/Shanghai /etc/localtime && echo Asia/Shanghai > /etc/timezone
COPY target/${APPNAME}-${VERSION}.jar /app/
ENTRYPOINT ["sh", "-c", "java -Djava.security.egd=file:/dev/./urandom -jar /app/${APPNAME}-${VERSION}.jar --spring.config.location=${CONFIG} --spring.profiles.active=@spring.profile@"]
EXPOSE 8100

#account-service-deployment.yml
kind: Deployment
apiVersion: apps/v1
metadata:
  name: account-service
  namespace: default
  labels:
    app: account-service
    group: com.xwallet
    version: 0.0.1-SNAPSHOT
    provider: fabric8
spec:
  replicas: 1
  selector:
    matchLabels:
      app: account-service
      group: com.xwallet
      version: 0.0.1-SNAPSHOT
      provider: fabric8
  template:
    metadata:
      labels:
        app: account-service
        group: com.xwallet
        version: 0.0.1-SNAPSHOT
        provider: fabric8
    spec:
      containers:
      - name: account-service
        #image: registry.gcalls.cn/xwallet/account-service:0.0.1-SNAPSHOT
        imagePullPolicy: Always
        ports:
        - containerPort: 8089

#account-service-service.yml
kind: Service
apiVersion: v1
metadata:
  name: account-service
  namespace: default
  labels:
    app: account-service
    group: com.xwallet
    version: 0.0.1-SNAPSHOT
    provider: fabric8
spec:
  type: NodePort
  ports:
  - protocol: TCP
    name: http
    port: 8080
    targetPort: 8080
  selector:
    app: account-service
    group: com.xwallet
    version: 0.0.1-SNAPSHOT
    provider: fabric8

#mvn clean install fabric8:push fabric8:deploy -Pkubernetes
mvn clean install -Pkubernetes
```

## 其他参考

> https://www.jianshu.com/p/f59f902fd885

