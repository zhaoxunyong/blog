---
title: Minikube安装与配置
date: 2017-09-25 17:08:32
categories: ["kubernetes"]
tags: ["kubernetes"]
toc: true
---
在容器编排工具中安装配置最复杂的就是Kubernetes，想要运行一个简单的容器集群环境，对于没有使用过Kubernetes的人来说，需要花费一定的时间去理解各组件的概念和功能，再做大量的安装配置工作才能运行一个kubernetes集群。

从Kubernetes1.3开始提供了一个叫Minikube的强大测试工具，可以在任意主机上运行单节点的小型集群，这个工具默认安装和配置了一个Linux VM，Docker和Kubernetes的相关组件，并且提供Dashboard。目前支持在Linux, OS X及Windows上安装，今天我们介绍的是在Windows上如何安装Minitube。

<!-- more -->

## 准备

以Windows为例，记录minikube的安装与使用。

Minitube项目地址：https://github.com/kubernetes/minikube

Minikube要求在BIOS中开户了VT-x/AMD-v虚拟化。

Kubernetes版本： v1.18.3

### 安装virtualbox

安装版本为VirtualBox 6.1.x

### 安装choco

在Linux世界中，安装一个软件不需要在浏览器中寻找软件的官网，然后将其下载下来，然后双击进行安装。只需要一条简单的命令，就可以完成搜索、安装、更新、卸载等所有操作。其实Windows下,也有这么一个包管理器，功能虽然不及Linux中那些包管理器强大，但是也让Windows下的软件安装方便了不少。这就是Chocolatey。

Chocolatey官网：https://chocolatey.org/

安装choco：

以管理员模式开启CMD：
```cmd
C:\>@"%SystemRoot%\System32\WindowsPowerShell\v1.0\powershell.exe" -NoProfile -InputFormat None -ExecutionPolicy Bypass -Command "iex ((New-Object System.Net.WebClient).DownloadString('https://chocolatey.org/install.ps1'))" && SET "PATH=%PATH%;%ALLUSERSPROFILE%\chocolatey\bin"

setx ChocolateyInstall E:\Chocolatey /M
```
可以测试是否能正常安装curl：

```cmd
C:\>choco install curl
#测试：
C:\>curl baidu.com
<html>
<meta http-equiv="refresh" content="0;url=http://www.baidu.com/">
</html>
```

## 安装minikube

### Windows

以管理员模式开启CMD：
```cmd
C:\>choco install –y minikube

C:\>minikube version
minikube version: v1.12.3
```

如果安装速度慢的话，可以开启代理：

```cmd
SET HTTP_PROXY=http://127.0.0.1:1080
SET HTTPS_PROXY=http://127.0.0.1:1080
```

### MacOS

下载对应的文件：

```bash
curl -Lo minikube https://storage.googleapis.com/minikube/releases/latest/minikube-darwin-amd64 && chmod +x minikube && sudo mv minikube /usr/local/bin/

curl -Lo kubectl https://storage.googleapis.com/kubernetes-release/release/v1.7.5/bin/darwin/amd64/kubectl && chmod +x kubectl && sudo mv kubectl /usr/local/bin/
```

## Linux

```bash
yum install bash-completion -y 
~/.bash_profile
alias k=kubectl
source <(kubectl completion bash | sed s/kubectl/k/g)
source /usr/share/bash-completion/bash_completion

cul -Lo minikube https://storage.googleapis.com/minikube/releases/latest/minikube-linux-amd64 && chmod +x minikube && sudo mv minikube /usr/local/bin/
curl -LO https://storage.googleapis.com/kubernetes-release/release/v1.18.3/bin/linux/amd64/kubectl
chmod +x kubectl && sudo mv kubectl /usr/local/bin/
yum localinstall VirtualBox-6.1-6.1.16_140961_el7-1.x86_64.rpm
yum localinstall kernel-devel-3.10.0-957.el7.x86_64.rpm 
rcvboxdrv setup
su - dev
#Starting minikube
#https://minikube.sigs.k8s.io/docs/handbook/vpn_and_proxy/
export http_proxy="http://192.168.101.175:1082"
export https_proxy=$http_proxy
export no_proxy="127.0.0.1,localhost,10.0.0.0/8,172.0.0.0/8,192.168.0.0/16,*.zerofinance.net"
minikube start --memory=8192 --cpus=4 --kubernetes-version=v1.18.3
```

## WSL

最新：直接在windows安装minikube，然后在wsl中也可以直接使用，无需在wsl安装minikube：

```bash
vim  ~/.bashrc
alias kubectl=kubectl.exe
alias k=kubectl
source <(kubectl completion bash | sed s/kubectl/k/g)
source /usr/share/bash-completion/bash_completion
#take affect with the following command:
.  ~/.bashrc
```

参考：https://kubernetes.io/blog/2020/05/21/wsl-docker-kubernetes-on-the-windows-desktop/#minikube-kubernetes-from-everywhere

安装docker，参考：http://blog.gcalls.cn/blog/2018/12/ubuntu%E7%BE%8E%E5%8C%96.html#Docker

kind安装：

```bash
#使用kind创建集群（可选，如果使用了minikube则不用）：https://www.kubernetes.org.cn/7723.html
# Download the latest version of Kind
curl -Lo ./kind https://github.com/kubernetes-sigs/kind/releases/download/v0.7.0/kind-$(uname)-amd64
# Make the binary executable
chmod +x ./kind
# Move the binary to your executable path
sudo mv ./kind /usr/local/bin/

# Check if the KUBECONFIG is not set
echo $KUBECONFIG
# Check if the .kube directory is created > if not, no need to create it
ls $HOME/.kube
# Create the cluster and give it a name (optional)
kind create cluster --name wslkind
# Check if the .kube has been created and populated with files
ls $HOME/.kube
kubectl get nodes
```

minikube安装：

```bash
# Edit the sudoers with the visudo command
sudo visudo
# Change the %sudo group to be password-less
%sudo   ALL=(ALL:ALL) NOPASSWD: ALL
# Press CTRL+X to exit
# Press Y to save
# Press Enter to confirm

# Download the latest version of Minikube
curl -Lo minikube https://storage.googleapis.com/minikube/releases/latest/minikube-linux-amd64
curl -LO https://storage.googleapis.com/kubernetes-release/release/v1.18.3/bin/linux/amd64/kubectl
chmod +x kubectl && sudo mv kubectl /usr/local/bin/
# Make the binary executable
chmod +x ./minikube
# Move the binary to your executable path
sudo mv ./minikube /usr/local/bin/

#Systemctl couldn't start
sudo apt install -y conntrack
sudo apt install -yqq daemonize dbus-user-session fontconfig
# Create the start-systemd-namespace script
sudo vi /usr/sbin/start-systemd-namespace
#!/bin/bash

SYSTEMD_PID=$(ps -ef | grep '/lib/systemd/systemd --system-unit=basic.target$' | grep -v unshare | awk '{print $2}')
if [ -z "$SYSTEMD_PID" ] || [ "$SYSTEMD_PID" != "1" ]; then
    export PRE_NAMESPACE_PATH="$PATH"
    (set -o posix; set) | \
        grep -v "^BASH" | \
        grep -v "^DIRSTACK=" | \
        grep -v "^EUID=" | \
        grep -v "^GROUPS=" | \
        grep -v "^HOME=" | \
        grep -v "^HOSTNAME=" | \
        grep -v "^HOSTTYPE=" | \
        grep -v "^IFS='.*"$'\n'"'" | \
        grep -v "^LANG=" | \
        grep -v "^LOGNAME=" | \
        grep -v "^MACHTYPE=" | \
        grep -v "^NAME=" | \
        grep -v "^OPTERR=" | \
        grep -v "^OPTIND=" | \
        grep -v "^OSTYPE=" | \
        grep -v "^PIPESTATUS=" | \
        grep -v "^POSIXLY_CORRECT=" | \
        grep -v "^PPID=" | \
        grep -v "^PS1=" | \
        grep -v "^PS4=" | \
        grep -v "^SHELL=" | \
        grep -v "^SHELLOPTS=" | \
        grep -v "^SHLVL=" | \
        grep -v "^SYSTEMD_PID=" | \
        grep -v "^UID=" | \
        grep -v "^USER=" | \
        grep -v "^_=" | \
        cat - > "$HOME/.systemd-env"
    echo "PATH='$PATH'" >> "$HOME/.systemd-env"
    exec sudo /usr/sbin/enter-systemd-namespace "$BASH_EXECUTION_STRING"
fi
if [ -n "$PRE_NAMESPACE_PATH" ]; then
    export PATH="$PRE_NAMESPACE_PATH"
fi

# Create the enter-systemd-namespace
sudo vi /usr/sbin/enter-systemd-namespace
#!/bin/bash

if [ "$UID" != 0 ]; then
    echo "You need to run $0 through sudo"
    exit 1
fi

SYSTEMD_PID="$(ps -ef | grep '/lib/systemd/systemd --system-unit=basic.target$' | grep -v unshare | awk '{print $2}')"
if [ -z "$SYSTEMD_PID" ]; then
    /usr/sbin/daemonize /usr/bin/unshare --fork --pid --mount-proc /lib/systemd/systemd --system-unit=basic.target
    while [ -z "$SYSTEMD_PID" ]; do
        SYSTEMD_PID="$(ps -ef | grep '/lib/systemd/systemd --system-unit=basic.target$' | grep -v unshare | awk '{print $2}')"
    done
fi

if [ -n "$SYSTEMD_PID" ] && [ "$SYSTEMD_PID" != "1" ]; then
    if [ -n "$1" ] && [ "$1" != "bash --login" ] && [ "$1" != "/bin/bash --login" ]; then
        exec /usr/bin/nsenter -t "$SYSTEMD_PID" -a \
            /usr/bin/sudo -H -u "$SUDO_USER" \
            /bin/bash -c 'set -a; source "$HOME/.systemd-env"; set +a; exec bash -c '"$(printf "%q" "$@")"
    else
        exec /usr/bin/nsenter -t "$SYSTEMD_PID" -a \
            /bin/login -p -f "$SUDO_USER" \
            $(/bin/cat "$HOME/.systemd-env" | grep -v "^PATH=")
    fi
    echo "Existential crisis"
fi

# Edit the permissions of the enter-systemd-namespace script
sudo chmod +x /usr/sbin/enter-systemd-namespace
# Edit the bash.bashrc file
sudo sed -i 2a"# Start or enter a PID namespace in WSL2\nsource /usr/sbin/start-systemd-namespace\n" /etc/bash.bashrc
#Finally, exit and launch a new session. You do not need to stop WSL2, a new session is enough

# Check if the KUBECONFIG is not set
echo $KUBECONFIG
# Check if the .kube directory is created > if not, no need to create it
ls $HOME/.kube
# Check if the .minikube directory is created > if yes, delete it
ls $HOME/.minikube
# Create the cluster with sudo
sudo sysctl fs.protected_regular=0
#Setting proxy in docker, and then:
export http_proxy="http://192.168.101.175:1082"
export https_proxy=$http_proxy
export no_proxy="127.0.0.1,localhost,10.0.0.0/8,172.0.0.0/8,192.168.0.0/16,*.zerofinance.net"
sudo minikube start --driver=none
sudo cp -a /root/.kube /home/dave/
sudo chown -R $USER $HOME/.kube $HOME/.minikube

```

## minikube常用命令

启动minikube：

```cmd
#minikube start --vm-driver=<driver_name> --image-repository=registry.cn-hangzhou.aliyuncs.com/google_containers
C:\>minikube start --image-repository=registry.cn-hangzhou.aliyuncs.com/google_containers
OR:
export http_proxy="http://192.168.101.175:1082"
export https_proxy=$http_proxy
export no_proxy="127.0.0.1,localhost,10.0.0.0/8,172.0.0.0/8,192.168.0.0/16,*.zerofinance.net"
C:\>minikube start --memory=8192 --cpus=4 --kubernetes-version=v1.18.3
Starting local Kubernetes v1.7.5 cluster...
Starting VM...
Getting VM IP address...
Moving files into cluster...
Setting up certs...
Connecting to cluster...
Setting up kubeconfig...
Starting cluster components...
Kubectl is now configured to use the cluster.
```

如果是Hyper-V的话：

注意：需要先创建外部网络，具体请参考[https://docs.microsoft.com/en-us/windows-server/virtualization/hyper-v/get-started/create-a-virtual-switch-for-hyper-v-virtual-machines](https://docs.microsoft.com/en-us/windows-server/virtualization/hyper-v/get-started/create-a-virtual-switch-for-hyper-v-virtual-machines)

```cmd
minikube.exe start --cpus 2 --memory 2048 --vm-driver="hyperv" --hyperv-virtual-switch="OuterNetwork" --docker-env HTTP_PROXY=http://192.168.10.1:1080 --docker-env HTTPS_PROXY=http://192.168.10.1:1080
minikube start --driver=none --docker-env HTTP_PROXY=http://192.168.101.175:1082 --docker-env HTTPS_PROXY=http://192.168.101.175:1082
```

注意：要加上代理，否则下载不了grc.io中的镜像。

停止minikube：

```cmd
C:\>minikube stop
```

删除minikube：

```cmd
C:\>minikube delete
```

测试minikube：

```cmd
C:\>kubectl get no
NAME       STATUS    AGE       VERSION
minikube   Ready     2h        v1.18.3
```


登录minikube虚拟机：

```cmd
C:\>minikube ssh
```

查看状态：

```cmd
C:\>minikube status
minikube: Running
cluster: Running
kubectl: Correctly Configured: pointing to minikube-vm at 192.168.99.100
```

## 安装一个程序

参考[https://kubernetes.io/zh/docs/setup/learning-environment/minikube/](https://kubernetes.io/zh/docs/setup/learning-environment/minikube/)


## Dashboard
Minikube自带了Kubernetes Dashboard。要浏览这个界面，可以使用内置的minikube dashboard命令：
```cmd
C:\> minikube dashboard
Opening kubernetes dashboard in default browser...
```

![dashboard](/images/dashboard.png)

## 参考
[https://github.com/kubernetes/minikube](https://github.com/kubernetes/minikube)
[https://kubernetes.io/docs/getting-started-guides/minikube/](https://kubernetes.io/docs/getting-started-guides/minikube/)
[https://kubernetes.io/zh/docs/setup/learning-environment/minikube/](https://kubernetes.io/zh/docs/setup/learning-environment/minikube/)
