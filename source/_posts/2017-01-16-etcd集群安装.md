---
title: etcd集群安装
date: 2017-01-16 18:23:01
categories: ["docker", "kubernetes"]
tags: ["docker", "kubernetes"]
---
## rpm安装
yum源配置：
```bash
tee /etc/yum.repos.d/k8s.repo <<-'EOF'
[k8s-repo]
name=kubernetes Repository
baseurl=https://rpm.mritd.me/centos/7/x86_64
enabled=1
gpgcheck=1
gpgkey=https://cdn.mritd.me/keys/rpm.public.key
EOF
```

安装：
```bash
yum install -y etcd
```

如果这个源不稳定的话，可以下载我创建好的源，直接通过yum localinstall *.rpm方式安装
```bash
git clone https://git.coding.net/zhaoxunyong/repo.git
cd repo/yum/etcd/x86_64
yum -y localinstall etcd-3.0.15-1.x86_64.rpm
```

## 配置
etcd0:
```bash
grep -v ^# /etc/etcd/etcd.conf 
ETCD_NAME=etcd0
ETCD_DATA_DIR="/var/lib/etcd/etcd"
ETCD_LISTEN_PEER_URLS="http://192.168.10.6:2380"
ETCD_LISTEN_CLIENT_URLS="http://127.0.0.1:2379,http://192.168.10.6:2379,http://192.168.10.6:4001"
ETCD_INITIAL_ADVERTISE_PEER_URLS="http://192.168.10.6:2380"
ETCD_INITIAL_CLUSTER="etcd0=http://192.168.10.6:2380,etcd1=http://192.168.10.7:2380,etcd2=http://192.168.10.8:2380"
#ETCD_DISCOVERY="https://discovery.etcd.io/248e628e9c77cc927dc1cc2749f3c9bf"
ETCD_INITIAL_CLUSTER_STATE="new"
ETCD_INITIAL_CLUSTER_TOKEN="etcd-cluster"
ETCD_ADVERTISE_CLIENT_URLS="http://192.168.10.6:2379,http://192.168.10.6:4001"
```

etcd1:
```bash
grep -v ^# /etc/etcd/etcd.conf 
ETCD_NAME=etcd1
ETCD_DATA_DIR="/var/lib/etcd/etcd"
ETCD_LISTEN_PEER_URLS="http://192.168.10.7:2380"
ETCD_LISTEN_CLIENT_URLS="http://127.0.0.1:2379,http://192.168.10.7:2379,http://192.168.10.7:4001"
ETCD_INITIAL_ADVERTISE_PEER_URLS="http://192.168.10.7:2380"
ETCD_INITIAL_CLUSTER="etcd0=http://192.168.10.6:2380,etcd1=http://192.168.10.7:2380,etcd2=http://192.168.10.8:2380"
#ETCD_DISCOVERY="https://discovery.etcd.io/248e628e9c77cc927dc1cc2749f3c9bf"
ETCD_INITIAL_CLUSTER_STATE="exist"
ETCD_INITIAL_CLUSTER_TOKEN="etcd-cluster"
ETCD_ADVERTISE_CLIENT_URLS="http://192.168.10.7:2379,http://192.168.10.7:4001"
```

etcd2:
```bash
grep -v ^# /etc/etcd/etcd.conf 
ETCD_NAME=etcd2
ETCD_DATA_DIR="/var/lib/etcd/etcd"
ETCD_LISTEN_PEER_URLS="http://192.168.10.8:2380"
ETCD_LISTEN_CLIENT_URLS="http://127.0.0.1:2379,http://192.168.10.8:2379,http://192.168.10.8:4001"
ETCD_INITIAL_ADVERTISE_PEER_URLS="http://192.168.10.8:2380"
ETCD_INITIAL_CLUSTER="etcd0=http://192.168.10.6:2380,etcd1=http://192.168.10.7:2380,etcd2=http://192.168.10.8:2380"
#ETCD_DISCOVERY="https://discovery.etcd.io/248e628e9c77cc927dc1cc2749f3c9bf"
ETCD_INITIAL_CLUSTER_STATE="exist"
ETCD_INITIAL_CLUSTER_TOKEN="etcd-cluster"
ETCD_ADVERTISE_CLIENT_URLS="http://192.168.10.8:2379,http://192.168.10.8:4001"
```

## 启动
```bash
systemctl daemon-reload
systemctl enable etcd
systemctl start etcd
```

## 测试
```bash
etcdctl cluster-health
etcdctl --endpoints "192.168.10.6:2379,http://192.168.10.6:4001" member list
```

## 基于已有集群的服务发现
获取集群标识 size 代表要创建的集群大小：
```bash
curl -w "\n" 'https://discovery.etcd.io/new?size=3'
# 返回如下
https://discovery.etcd.io/f6a252c5240cc89b91fa00dac95d5732
```

设置集群标识,删除掉 ETCD_INITIAL_CLUSTER 字段,添加：
```bash
ETCD_DISCOVERY="https://discovery.etcd.io/f6a252c5240cc89b91fa00dac95d5732"
```

也可以通过已有的集群自动发现：
首先需要在已经搭建的etcd中创建用于发现的url
```bash
curl -X PUT http://192.168.10.16:2379/v2/keys/discovery/6c007a14875d53d9bf0ef5a6fc0257c817f0fb83/_config/size -d value=3
#返回：
{"action":"set","node":{"key":"/discovery/6c007a14875d53d9bf0ef5a6fc0257c817f0fb83/_config/size","value":"3","modifiedIndex":170010,"createdIndex":170010}}
```
其中192.168.10.16为另外的etcd集群环境。


如上表示创建一个集群大小为3的etcd发现url，创建成功后按如下配置启动各节点，可以参考手动启动的命令：
```bash
./etcd --name infra0 --initial-advertise-peer-urls http://192.168.10.6:2380 \
  --listen-peer-urls http://192.168.10.6:2380 \
  --listen-client-urls http://192.168.10.6:2379,http://127.0.0.1:2379 \
  --advertise-client-urls http://192.168.10.6:2379 \ 
 --discovery http://192.168.10.16:2379/v2/keys/discovery/6c007a14875d53d9bf0ef5a6fc0257c817f0fb83
 ```

## 参考
> https://mritd.me/2016/09/01/Etcd-%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA/
> http://blog.csdn.net/u010511236/article/details/52386229